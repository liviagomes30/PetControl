<!DOCTYPE html>
<html lang="pt-br">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="description" content="Edição de Registro de Vacinação - PetControl" />
        <title>PetControl - Editar Vacinação</title>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css" />
        <link rel="stylesheet" href="../../assets/css/style.css" />
        <script src="../../assets/js/components/sidebar.js" defer></script>
    </head>
    <body>
        <main class="main-content">
            <header class="content-header">
                <button class="btn-back" onclick="window.location.href='listarVacinacoes.html'" aria-label="Voltar para histórico de vacinações">
                    <i class="bi bi-arrow-left"></i> Voltar
                </button>
                <h1>Editar Registro de Vacinação</h1>
            </header>

            <div class="form-container">
                <form id="editarVacinacaoForm" novalidate>
                    <input type="hidden" id="id_vacinacao" value="0" />

                    <div class="form-group">
                        <label for="id_vacina" class="required">Vacina Aplicada</label>
                        <select id="id_vacina" name="id_vacina" required aria-describedby="vacina-error vacina-help">
                            <option value="">Selecione o tipo de vacina...</option>
                        </select>
                        <div class="error-message" id="vacina-error" aria-live="polite"></div>
                        <small id="vacina-help" class="form-help-text">Selecione o tipo de vacina que foi aplicada.</small>
                    </div>

                    <div class="form-group">
                        <label for="id_animal" class="required">Animal</label>
                        <select id="id_animal" name="id_animal" required aria-describedby="animal-error animal-help">
                            <option value="">Selecione o animal...</option>
                        </select>
                        <div class="error-message" id="animal-error" aria-live="polite"></div>
                        <small id="animal-help" class="form-help-text">Selecione o animal que recebeu a vacina.</small>
                    </div>

                    <div class="form-group">
                        <label for="data_vacinacao" class="required">Data da Vacinação</label>
                        <input type="date" id="data_vacinacao" name="data_vacinacao" required aria-describedby="data-vacinacao-error"/>
                        <div class="error-message" id="data-vacinacao-error" aria-live="polite"></div>
                    </div>

                    <div class="form-group">
                        <label for="local_vacinacao" class="required">Local da Vacinação</label>
                        <input type="text" id="local_vacinacao" name="local_vacinacao" required
                               placeholder="Ex: Clínica Veterinária X, Evento Y, Abrigo"
                               aria-describedby="local-vacinacao-error"/>
                        <div class="error-message" id="local-vacinacao-error" aria-live="polite"></div>
                    </div>

                    <hr class="form-divider">
                    <h2 class="form-section-title">Detalhes da Dose (Opcional)</h2>

                    <div class="form-group">
                        <label for="lote_vacina">Lote da Vacina</label>
                        <input type="text" id="lote_vacina" name="lote_vacina" placeholder="Ex: LOTE123XYZ" />
                    </div>

                    <div class="form-group">
                        <label for="data_validade_vacina">Data de Validade da Vacina</label>
                        <input type="date" id="data_validade_vacina" name="data_validade_vacina" />
                    </div>

                    <div class="form-group">
                        <label for="laboratorio_vacina">Laboratório da Vacina</label>
                        <input type="text" id="laboratorio_vacina" name="laboratorio_vacina" placeholder="Ex: Zoetis, MSD Saúde Animal" />
                    </div>

                    <div class="form-buttons">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle"></i> Salvar Alterações
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="window.location.href='listarVacinacoes.html'">
                            Cancelar
                        </button>
                    </div>
                </form>
            </div>

            <div id="toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-icon success"><i class="bi bi-check-circle"></i></div>
                <div class="toast-content">
                    <div class="toast-title" id="toastTitle">Sucesso!</div>
                    <div class="toast-message" id="toastMessage">Operação realizada com sucesso.</div>
                </div>
                <button class="toast-close" aria-label="Fechar notificação"><i class="bi bi-x"></i></button>
            </div>

            <div id="loadingOverlay" class="loading-overlay">
                <div class="spinner" role="status"><span class="visually-hidden">Carregando...</span></div>
            </div>
        </main>

        <script type="module">
            import VacinacaoController from '../../assets/js/controllers/VacinacaoController.js';
            import UIComponents from '../../assets/js/components/uiComponents.js';
            import MensagensPadroes from '../../assets/js/utils/mensagensPadroes.js';

            document.addEventListener("DOMContentLoaded", async () => {
                const urlParams = new URLSearchParams(window.location.search);
                const idVacinacao = urlParams.get("id");

                if (!idVacinacao) {
                    UIComponents.ModalErro.mostrar("ID do registro de vacinação não fornecido para edição.");
                    setTimeout(() => { window.location.href = 'listarVacinacoes.html'; }, 3000);
                    return;
                }

                if (!window.vacinacaoEdicaoController) {
                    window.vacinacaoEdicaoController = new VacinacaoController();
                }

                await window.vacinacaoEdicaoController.carregarVacinacaoParaEdicao(idVacinacao);

                const form = document.getElementById("editarVacinacaoForm");
                const loadingOverlay = document.getElementById("loadingOverlay");

                function attachLiveValidation(inputElement, errorElementId) {
                    if (inputElement) {
                        const handler = () => {
                            inputElement.classList.remove("invalid");
                            const errorElement = document.getElementById(errorElementId);
                            if(errorElement) errorElement.textContent = "";
                        };
                        inputElement.addEventListener('input', handler);
                        inputElement.addEventListener('change', handler);
                    }
                }
                attachLiveValidation(document.getElementById("id_vacina"), "vacina-error");
                attachLiveValidation(document.getElementById("id_animal"), "animal-error");
                attachLiveValidation(document.getElementById("data_vacinacao"), "data-vacinacao-error");
                attachLiveValidation(document.getElementById("local_vacinacao"), "local-vacinacao-error");

                if (form) {
                    form.addEventListener("submit", async function (event) {
                        event.preventDefault();

                        const formDataFromPage = {
                            id_vacinacao: document.getElementById("id_vacinacao").value,
                            id_vacina: document.getElementById("id_vacina").value,
                            id_animal: document.getElementById("id_animal").value,
                            data_vacinacao: document.getElementById("data_vacinacao").value,
                            local_vacinacao: document.getElementById("local_vacinacao").value,
                            lote_vacina: document.getElementById("lote_vacina").value,
                            data_validade_vacina: document.getElementById("data_validade_vacina").value,
                            laboratorio_vacina: document.getElementById("laboratorio_vacina").value
                        };

                        window.vacinacaoEdicaoController.atualizarVacinacao(idVacinacao, formDataFromPage)
                                .then(() => {
                                    setTimeout(() => {
                                        window.location.href = 'listarVacinacoes.html?message=' + encodeURIComponent("Registro de vacinação atualizado com sucesso!");
                                    }, 1500);
                                })
                                .catch((error) => {
                                    console.error("Falha ao atualizar registro de vacinação (na página HTML):", error);
                                });
                    });
                }
            });
        </script>
    </body>
</html>