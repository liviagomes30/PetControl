<!DOCTYPE html>
<html lang="pt-br">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="description" content="Cadastro de Vacinação - PetControl" />
        <title>PetControl - Nova Vacinação</title>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css" />
        <link rel="stylesheet" href="../../assets/css/style.css" />
        <script src="../../assets/js/components/sidebar.js" defer></script>
    </head>
    <body>
        <main class="main-content">
            <header class="content-header">
                <button class="btn-back" onclick="window.location.href='listarVacinacoes.html'" aria-label="Voltar">
                    <i class="bi bi-arrow-left"></i> Voltar
                </button>
                <h1>Registrar Nova Vacinação</h1>
            </header>

            <div class="form-container">
                <form id="vacinacaoForm" novalidate>
                    <input type="hidden" id="id_vacinacao" value="0" />

                    <div class="form-group search-group">
                        <label for="vacinaSearchInput" class="required">Vacina Aplicada</label>
                        <input type="text" id="vacinaSearchInput" class="form-input-searchable" required autocomplete="off" placeholder="Digite para pesquisar o tipo de vacina..."/>
                        <div id="vacinaSearchResults" class="search-results-dropdown" style="display: none;"></div>
                        <input type="hidden" id="id_vacina" name="id_vacina" />
                        <div class="error-message" id="vacina-error" aria-live="polite"></div>
                    </div>

                    <div class="form-group search-group">
                        <label for="animalSearchInput" class="required">Animal</label>
                        <input type="text" id="animalSearchInput" class="form-input-searchable" required autocomplete="off" placeholder="Digite para pesquisar o animal..."/>
                        <div id="animalSearchResults" class="search-results-dropdown" style="display: none;"></div>
                        <input type="hidden" id="id_animal" name="id_animal" />
                        <div class="error-message" id="animal-error" aria-live="polite"></div>
                    </div>

                    <div class="form-group">
                        <label for="data_vacinacao" class="required">Data da Vacinação</label>
                        <input type="date" id="data_vacinacao" name="data_vacinacao" required/>
                        <div class="error-message" id="data-vacinacao-error" aria-live="polite"></div>
                    </div>

                    <div class="form-group">
                        <label for="local_vacinacao" class="required">Local da Vacinação</label>
                        <input type="text" id="local_vacinacao" name="local_vacinacao" required placeholder="Ex: Clínica Veterinária X, Abrigo"/>
                        <div class="error-message" id="local-vacinacao-error" aria-live="polite"></div>
                    </div>

                    <hr class="form-divider">
                    <h2 class="form-section-title">Detalhes da Dose (Opcional)</h2>

                    <div class="form-group">
                        <label for="lote_vacina">Lote da Vacina</label>
                        <input type="text" id="lote_vacina" name="lote_vacina" placeholder="Ex: LOTE123XYZ" />
                    </div>

                    <div class="form-group">
                        <label for="data_validade_vacina">Data de Validade da Vacina</label>
                        <input type="date" id="data_validade_vacina" name="data_validade_vacina" />
                    </div>

                    <div class="form-group">
                        <label for="laboratorio_vacina">Laboratório da Vacina</label>
                        <input type="text" id="laboratorio_vacina" name="laboratorio_vacina" placeholder="Ex: Zoetis, MSD Saúde Animal" />
                    </div>

                    <div class="form-buttons">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle"></i> Confirmar Vacinação
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="window.location.href='listarVacinacoes.html'">
                            Cancelar
                        </button>
                    </div>
                </form>
            </div>
            <div id="loadingOverlay" class="loading-overlay">
                <div class="spinner" role="status"><span class="visually-hidden">Carregando...</span></div>
            </div>
        </main>
        <script type="module">
            import VacinacaoController from '../../assets/js/controllers/VacinacaoController.js';

            document.addEventListener("DOMContentLoaded", () => {
                if (!window.vacinacaoCadastroController) {
                    window.vacinacaoCadastroController = new VacinacaoController();
                }

                window.vacinacaoCadastroController.inicializarFormularioCadastro();

                const form = document.getElementById("vacinacaoForm");
                if (form) {
                    form.addEventListener("submit", (event) => {
                        event.preventDefault();

                        const formData = {
                            id_vacina: document.getElementById("id_vacina").value,
                            id_animal: document.getElementById("id_animal").value,
                            data_vacinacao: document.getElementById("data_vacinacao").value,
                            local_vacinacao: document.getElementById("local_vacinacao").value,
                            lote_vacina: document.getElementById("lote_vacina").value,
                            data_validade_vacina: document.getElementById("data_validade_vacina").value,
                            laboratorio_vacina: document.getElementById("laboratorio_vacina").value
                        };

                        window.vacinacaoCadastroController.salvarVacinacao(formData)
                                .then(() => {
                                    form.reset();
                                    document.querySelectorAll('.error-message').forEach(el => el.textContent = '');
                                });
                    });
                }
            });
        </script>
    </body>
</html>